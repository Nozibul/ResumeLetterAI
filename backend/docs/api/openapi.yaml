# Main OpenAPI specification for the API
openapi: 3.0.3

info:
  title: ResumeLetterAI API
  version: 1.0.0
  description: |
    Production-ready REST API for resume and cover letter generation platform.
    
    ## Features
    - User authentication with JWT
    - Resume template management
    - Cover letter generation
    - User profile management
    - Review and rating system
    
    ## Rate Limiting
    - Anonymous users: 10 requests/minute
    - Authenticated users: 100 requests/minute
    - Write operations: 10 requests/minute
    
    ## Error Handling
    All errors follow RFC 7807 Problem Details format.
    
  contact:
    name: ResumeLetterAI Support
    email: nozibulislamspi@gmail.com
    url: https://resumeletterai.com
  
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000/api/v1
    description: Local development server
  - url: https://api.resumeletterai.com/api/v1
    description: Production server

tags:
  - name: Health
    description: Health check endpoints
  - name: Authentication
    description: User authentication and authorization
  - name: Users
    description: User profile management
  - name: Templates
    description: Resume and cover letter templates
  - name: Reviews
    description: Template reviews and ratings

# ============================================
# API ENDPOINTS
# ============================================
paths:
  # ============================================
  # HEALTH CHECK ENDPOINTS
  # ============================================
  /health:
    get:
      summary: Health check
      description: Check if API is running and all services are healthy
      tags: [Health]
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "healthy"
                timestamp: "2025-10-07T10:30:00Z"
                services:
                  database: "connected"
                  redis: "connected"
                uptime: 3600

  # ============================================
  # AUTHENTICATION ENDPOINTS
  # ============================================
  /auth/register:
    post:
      summary: Register new user
      description: Create a new user account
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
            example:
              name: "John Doe"
              email: "john@example.com"
              password: "SecurePass123!"
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      summary: User login
      description: Authenticate user and get access token
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            example:
              email: "john@example.com"
              password: "SecurePass123!"
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'

  /auth/refresh:
    post:
      summary: Refresh access token
      description: Get new access token using refresh token
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
                  example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/logout:
    post:
      summary: User logout
      description: Invalidate user session and tokens
      tags: [Authentication]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/google:
    get:
      summary: Google OAuth login
      description: Redirect to Google OAuth consent screen
      tags: [Authentication]
      responses:
        '302':
          description: Redirect to Google OAuth

  /auth/google/callback:
    get:
      summary: Google OAuth callback
      description: Handle Google OAuth callback and create/login user
      tags: [Authentication]
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OAuth login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  # ============================================
  # USER PROFILE ENDPOINTS
  # ============================================
  /users/me:
    get:
      summary: Get current user profile
      description: Retrieve authenticated user's profile information
      tags: [Users]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/UserProfile'
        '401':
          $ref: '#/components/responses/Unauthorized'

    patch:
      summary: Update user profile
      description: Update authenticated user's profile information
      tags: [Users]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
            example:
              fullName: "John Smith"
              preferences:
                language: "bn"
                notifications:
                  email: false
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Profile updated successfully"
                  data:
                    $ref: '#/components/schemas/UserProfile'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

    delete:
      summary: Delete user account
      description: Soft delete user account (sets isActive to false)
      tags: [Users]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Account deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ============================================
  # PASSWORD MANAGEMENT ENDPOINTS
  # ============================================
  /users/me/password:
    put:
      summary: Change password
      description: Change authenticated user's password
      tags: [Password]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangePasswordRequest'
            example:
              currentPassword: "OldPass123!"
              newPassword: "NewSecurePass456!"
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/forgot-password:
    post:
      summary: Request password reset
      description: Send password reset email with token
      tags: [Password]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForgotPasswordRequest'
            example:
              email: "john@example.com"
      responses:
        '200':
          description: Password reset email sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /auth/reset-password:
    post:
      summary: Reset password
      description: Reset password using token from email
      tags: [Password]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
            example:
              token: "a1b2c3d4e5f6..."
              newPassword: "NewSecurePass789!"
      responses:
        '200':
          description: Password reset successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  # ============================================
  # EMAIL VERIFICATION ENDPOINTS
  # ============================================
  /auth/verify-email:
    post:
      summary: Verify email address
      description: Verify user email using token from email
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyEmailRequest'
            example:
              token: "a1b2c3d4e5f6..."
      responses:
        '200':
          description: Email verified successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /auth/resend-verification:
    post:
      summary: Resend verification email
      description: Resend email verification link
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResendVerificationRequest'
            example:
              email: "john@example.com"
      responses:
        '200':
          description: Verification email sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  # ============================================
  # TEMPLATES
  # ============================================
  /templates:
    get:
      summary: List all templates
      description: Get paginated list of resume templates
      tags: [Templates]
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/Limit'
        - name: category
          in: query
          description: Filter by template category
          schema:
            type: string
            enum: [professional, creative, academic, technical, modern]
        - name: sort
          in: query
          description: Sort order
          schema:
            type: string
            enum: [newest, oldest, popular, rating]
            default: newest
        - name: search
          in: query
          description: Search by template name or tags
          schema:
            type: string
      responses:
        '200':
          description: Templates retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TemplateListResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

    post:
      summary: Create new template
      description: Create a new resume template (Admin/Creator only)
      tags: [Templates]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTemplateRequest'
      responses:
        '201':
          description: Template created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /templates/{id}:
    get:
      summary: Get template by ID
      description: Retrieve detailed information about a specific template
      tags: [Templates]
      parameters:
        - $ref: '#/components/parameters/TemplateId'
      responses:
        '200':
          description: Template retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: Update template
      description: Update template information (Admin/Creator only)
      tags: [Templates]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TemplateId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTemplateRequest'
      responses:
        '200':
          description: Template updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Delete template
      description: Delete a template (Admin only)
      tags: [Templates]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TemplateId'
      responses:
        '204':
          description: Template deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /templates/{id}/preview:
    get:
      summary: Get template preview
      description: Get template preview image or HTML
      tags: [Templates]
      parameters:
        - $ref: '#/components/parameters/TemplateId'
      responses:
        '200':
          description: Preview retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  previewUrl:
                    type: string
                    format: uri
                  thumbnailUrl:
                    type: string
                    format: uri
        '404':
          $ref: '#/components/responses/NotFound'

  # ============================================
  # REVIEWS
  # ============================================
  /templates/{id}/reviews:
    get:
      summary: Get template reviews
      description: Get paginated list of reviews for a template
      tags: [Reviews]
      parameters:
        - $ref: '#/components/parameters/TemplateId'
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/Limit'
        - name: sort
          in: query
          description: Sort order
          schema:
            type: string
            enum: [newest, oldest, helpful, rating_high, rating_low]
            default: newest
      responses:
        '200':
          description: Reviews retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewListResponse'
        '404':
          $ref: '#/components/responses/NotFound'

    post:
      summary: Create review
      description: Add a review for a template
      tags: [Reviews]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TemplateId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateReviewRequest'
      responses:
        '201':
          description: Review created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: User already reviewed this template
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /reviews/{id}:
    patch:
      summary: Update review
      description: Update user's own review
      tags: [Reviews]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Review ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateReviewRequest'
      responses:
        '200':
          description: Review updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Delete review
      description: Delete user's own review (or admin)
      tags: [Reviews]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Review ID
      responses:
        '204':
          description: Review deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

# ============================================
# REUSABLE COMPONENTS
# ============================================
components:
  schemas:
    # ============================================
    # AUTHENTICATION SCHEMAS
    # ============================================
    RegisterRequest:
      type: object
      required:
        - fullName
        - email
        - password
      properties:
        fullName:
          type: string
          minLength: 2
          maxLength: 50
          example: "John Doe"
        email:
          type: string
          format: email
          example: "john@example.com"
        password:
          type: string
          format: password
          minLength: 8
          example: "SecurePass123!"
        authProvider:
          type: string
          enum: [local, google]
          default: local
        preferences:
          type: object
          properties:
            language:
              type: string
              enum: [en, bn]
              default: en
            timezone:
              type: string
              default: UTC
            notifications:
              type: object
              properties:
                email:
                  type: boolean
                  default: true
                push:
                  type: boolean
                  default: false

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: "john@example.com"
        password:
          type: string
          format: password
          example: "SecurePass123!"

    AuthResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "User registered successfully"
        data:
          type: object
          properties:
            user:
              $ref: '#/components/schemas/UserProfile'
            tokens:
              $ref: '#/components/schemas/TokenResponse'

    TokenResponse:
      type: object
      properties:
        accessToken:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        refreshToken:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        expiresIn:
          type: number
          example: 3600

    # ============================================
    # USER SCHEMAS
    # ============================================
    UserProfile:
      type: object
      properties:
        id:
          type: string
          example: "507f1f77bcf86cd799439011"
        fullName:
          type: string
          example: "John Doe"
        email:
          type: string
          format: email
          example: "john@example.com"
        role:
          type: string
          enum: [user, admin, premium]
          example: "user"
        authProvider:
          type: string
          enum: [local, google]
          example: "local"
        isActive:
          type: boolean
          example: true
        isEmailVerified:
          type: boolean
          example: false
        lastLoginAt:
          type: string
          format: date-time
          nullable: true
          example: "2024-01-15T10:30:00Z"
        lastLoginIP:
          type: string
          nullable: true
          example: "192.168.1.1"
        lastActiveAt:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"
        preferences:
          type: object
          properties:
            language:
              type: string
              enum: [en, bn]
              example: "en"
            timezone:
              type: string
              example: "UTC"
            notifications:
              type: object
              properties:
                email:
                  type: boolean
                  example: true
                push:
                  type: boolean
                  example: false
        metadata:
          type: object
          additionalProperties: true
          example:
            aiPreferences: {}
            customFields: {}
        createdAt:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"

    UpdateUserRequest:
      type: object
      properties:
        fullName:
          type: string
          minLength: 2
          maxLength: 50
          example: "John Smith"
        preferences:
          type: object
          properties:
            language:
              type: string
              enum: [en, bn]
            timezone:
              type: string
            notifications:
              type: object
              properties:
                email:
                  type: boolean
                push:
                  type: boolean
        metadata:
          type: object
          additionalProperties: true
          example:
            customField: "value"

    ChangePasswordRequest:
      type: object
      required:
        - currentPassword
        - newPassword
      properties:
        currentPassword:
          type: string
          format: password
          example: "OldPass123!"
        newPassword:
          type: string
          format: password
          minLength: 8
          example: "NewSecurePass456!"

    # ============================================
    # PASSWORD RESET SCHEMAS
    # ============================================
    ForgotPasswordRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          example: "john@example.com"

    ResetPasswordRequest:
      type: object
      required:
        - token
        - newPassword
      properties:
        token:
          type: string
          example: "a1b2c3d4e5f6..."
        newPassword:
          type: string
          format: password
          minLength: 8
          example: "NewSecurePass789!"

    # ============================================
    # EMAIL VERIFICATION SCHEMAS
    # ============================================
    VerifyEmailRequest:
      type: object
      required:
        - token
      properties:
        token:
          type: string
          example: "a1b2c3d4e5f6..."

    ResendVerificationRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          example: "john@example.com"

    # ============================================
    # COMMON RESPONSE SCHEMAS
    # ============================================
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Operation successful"
        data:
          type: object
          nullable: true

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: "Error message"
        error:
          type: object
          properties:
            code:
              type: string
              example: "VALIDATION_ERROR"
            details:
              type: array
              items:
                type: object
                properties:
                  field:
                    type: string
                  message:
                    type: string

  # ============================================
  # REUSABLE RESPONSES
  # ============================================
  responses:
    BadRequest:
      description: Bad request - Invalid input
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            message: "Validation failed"
            error:
              code: "VALIDATION_ERROR"
              details:
                - field: "email"
                  message: "Please provide a valid email address"

    Unauthorized:
      description: Unauthorized - Invalid or missing token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            message: "Authentication failed"
            error:
              code: "UNAUTHORIZED"

    Forbidden:
      description: Forbidden - Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            message: "You don't have permission to access this resource"
            error:
              code: "FORBIDDEN"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            message: "Resource not found"
            error:
              code: "NOT_FOUND"

    Conflict:
      description: Conflict - Resource already exists
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            message: "Email already exists"
            error:
              code: "CONFLICT"

    TooManyRequests:
      description: Too many requests - Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            message: "Too many login attempts. Account locked for 15 minutes"
            error:
              code: "ACCOUNT_LOCKED"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            message: "Something went wrong"
            error:
              code: "INTERNAL_ERROR"

  # ============================================
  # SECURITY SCHEMES
  # ============================================
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: "JWT token for authentication. Format: Bearer {token}"