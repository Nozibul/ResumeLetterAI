name: ðŸš€ Complete CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - '**' 
      # - 'feature/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      force_skip_tests:
        description: 'Force skip all tests'
        required: false
        default: false
        type: boolean
      # deploy_environment:
      #   description: 'Deploy to environment'
      #   required: false
      #   default: 'none'
      #   type: choice
      #   options:
      #     - none
      #     - staging
      #     - production
      # run_performance_tests:
      #   description: 'Run performance tests'
      #   required: false
      #   default: false
      #   type: boolean

# Security permissions (principle of least privilege)
permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write
  security-events: write
  issues: write

# Global environment variables
env:
  NODE_VERSION: '20'
  YARN_CACHE_FOLDER: ~/.cache/yarn
  FORCE_SKIP_TESTS: ${{ github.event.inputs.force_skip_tests == 'true' || contains(github.event.head_commit.message, '[skip tests]') }}

jobs:
  # =========================================
  # JOB 1: MONOREPO VERSIONING
  # =========================================
  monorepo-versioning:
    name: ðŸ“¦ Monorepo Versioning
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      changed-packages: ${{ steps.version.outputs.changed-packages }}
      release-type: ${{ steps.version.outputs.release-type }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ðŸ“‹ Generate version and detect changes
        id: version
        run: |
          # Install semver tool
          npm install -g semver
          
          # Get current version from package.json
          if [ -f "package.json" ]; then
            CURRENT_VERSION=$(node -p "require('./package.json').version")
          else
            CURRENT_VERSION="0.0.0"
          fi
          
          # Determine release type based on branch
          BRANCH_NAME="${{ github.ref_name }}"
          if [[ "$BRANCH_NAME" == "main" ]]; then
            RELEASE_TYPE="patch"
          elif [[ "$BRANCH_NAME" == "develop" ]]; then
            RELEASE_TYPE="minor"

          else
            RELEASE_TYPE="prerelease"
          fi
          
          # Generate new version
          NEW_VERSION=$(semver -i $RELEASE_TYPE $CURRENT_VERSION)
          
          # Detect changed packages in monorepo
          CHANGED_PACKAGES="[]"
          if [ -d "packages" ]; then
            CHANGED_PACKAGES=$(find packages -name "package.json" -exec dirname {} \; | jq -R -s -c 'split("\n")[:-1]')
          elif [ -d "apps" ]; then
            CHANGED_PACKAGES=$(find apps -name "package.json" -exec dirname {} \; | jq -R -s -c 'split("\n")[:-1]')
          fi
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "changed-packages=$CHANGED_PACKAGES" >> $GITHUB_OUTPUT
          echo "release-type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Current Version: $CURRENT_VERSION"
          echo "ðŸ†• New Version: $NEW_VERSION"
          echo "ðŸ”„ Release Type: $RELEASE_TYPE"
          echo "ðŸ“‚ Changed Packages: $CHANGED_PACKAGES"

  # =========================================
  # JOB 2: FRONTEND & BACKEND DETECTION
  # =========================================
  detect-services:
    name: Frontend & Backend Detection
    runs-on: ubuntu-latest
    outputs:
      has-frontend: ${{ steps.detect.outputs.has-frontend }}
      has-backend: ${{ steps.detect.outputs.has-backend }}
      frontend-framework: ${{ steps.detect.outputs.frontend-framework }}
      backend-framework: ${{ steps.detect.outputs.backend-framework }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect Frontend & Backend
        id: detect
        run: |
          HAS_FRONTEND=false
          HAS_BACKEND=false
          FRONTEND_FRAMEWORK="none"
          BACKEND_FRAMEWORK="none"
          
          # Detect Frontend
          if [ -f "package.json" ]; then
            if grep -q "react" package.json; then
              HAS_FRONTEND=true
              FRONTEND_FRAMEWORK="react"
            elif grep -q "vue" package.json; then
              HAS_FRONTEND=true
              FRONTEND_FRAMEWORK="vue"
            elif grep -q "next" package.json; then
              HAS_FRONTEND=true
              FRONTEND_FRAMEWORK="nextjs"
            fi
          fi
          
          # Detect Backend
          if [ -f "package.json" ]; then
            if grep -q "express" package.json || grep -q "fastify" package.json || grep -q "koa" package.json; then
              HAS_BACKEND=true
              BACKEND_FRAMEWORK="nodejs"
            fi
          fi
          
          echo "has-frontend=$HAS_FRONTEND" >> $GITHUB_OUTPUT
          echo "has-backend=$HAS_BACKEND" >> $GITHUB_OUTPUT
          echo "frontend-framework=$FRONTEND_FRAMEWORK" >> $GITHUB_OUTPUT
          echo "backend-framework=$BACKEND_FRAMEWORK" >> $GITHUB_OUTPUT
          
          echo "Frontend: $HAS_FRONTEND ($FRONTEND_FRAMEWORK)"
          echo "Backend: $HAS_BACKEND ($BACKEND_FRAMEWORK)"

  # =========================================
  # JOB 3: CHANGE DETECTION
  # =========================================
  change-detection:
    name: ðŸ”„ Change Detection
    runs-on: ubuntu-latest
    outputs:
      changed-files: ${{ steps.changes.outputs.changed-files }}
      changed-packages: ${{ steps.changes.outputs.changed-packages }}
      should-test-frontend: ${{ steps.changes.outputs.should-test-frontend }}
      should-test-backend: ${{ steps.changes.outputs.should-test-backend }}
      should-deploy: ${{ steps.changes.outputs.should-deploy }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”„ Detect changed files
        id: changes
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD)
          fi
          
          # Convert to JSON array
          CHANGED_FILES_JSON=$(echo "$CHANGED_FILES" | jq -R -s -c 'split("\n")[:-1]')
          
          # Detect changed packages
          CHANGED_PACKAGES=[]
          if echo "$CHANGED_FILES" | grep -E "^(frontend/|src/|components/|pages/)" > /dev/null; then
            SHOULD_TEST_FRONTEND=true
          else
            SHOULD_TEST_FRONTEND=false
          fi
          
          if echo "$CHANGED_FILES" | grep -E "^(backend/|server/|api/)" > /dev/null; then
            SHOULD_TEST_BACKEND=true
          else
            SHOULD_TEST_BACKEND=false
          fi
          
          # Check if deployment files changed
          if echo "$CHANGED_FILES" | grep -E "(package\.json|yarn\.lock|Dockerfile|docker-compose)" > /dev/null; then
            SHOULD_DEPLOY=true
          else
            SHOULD_DEPLOY=false
          fi
          
          echo "changed-files=$CHANGED_FILES_JSON" >> $GITHUB_OUTPUT
          echo "changed-packages=$CHANGED_PACKAGES" >> $GITHUB_OUTPUT
          echo "should-test-frontend=$SHOULD_TEST_FRONTEND" >> $GITHUB_OUTPUT
          echo "should-test-backend=$SHOULD_TEST_BACKEND" >> $GITHUB_OUTPUT
          echo "should-deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          
          echo "ðŸ“ Changed Files: $(echo "$CHANGED_FILES" | wc -l) files"
          echo "ðŸŽ¨ Test Frontend: $SHOULD_TEST_FRONTEND"
          echo "âš™ï¸ Test Backend: $SHOULD_TEST_BACKEND"
          echo "ðŸš€ Should Deploy: $SHOULD_DEPLOY"

  # =========================================
  # JOB 4: FILE-LEVEL SELECTIVE TESTING
  # =========================================
  selective-testing:
    name: ðŸŽ¯ File-level Selective Testing
    runs-on: ubuntu-latest
    needs: [change-detection]
    outputs:
      test-files: ${{ steps.selective.outputs.test-files }}
      test-suites: ${{ steps.selective.outputs.test-suites }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Generate selective test list
        id: selective
        run: |
          CHANGED_FILES='${{ needs.change-detection.outputs.changed-files }}'
          TEST_FILES=[]
          TEST_SUITES=[]
          
          # Find corresponding test files for changed files
          echo "$CHANGED_FILES" | jq -r '.[]' | while read file; do
            # Remove extension and find test files
            BASE_NAME=$(echo "$file" | sed 's/\.[^.]*$//')
            
            # Look for test files
            if [ -f "${BASE_NAME}.test.js" ]; then
              TEST_FILES=$(echo "$TEST_FILES" | jq ". + [\"${BASE_NAME}.test.js\"]")
            fi
            
            if [ -f "${BASE_NAME}.test.ts" ]; then
              TEST_FILES=$(echo "$TEST_FILES" | jq ". + [\"${BASE_NAME}.test.ts\"]")
            fi
            
            if [ -f "${BASE_NAME}.spec.js" ]; then
              TEST_FILES=$(echo "$TEST_FILES" | jq ". + [\"${BASE_NAME}.spec.js\"]")
            fi
            
            # Check test directories
            if [ -d "__tests__" ] && find __tests__ -name "*$(basename $BASE_NAME)*" | head -1 | grep -q .; then
              TEST_SUITES=$(echo "$TEST_SUITES" | jq ". + [\"$(basename $BASE_NAME)\"]")
            fi
          done
          
          # If no specific tests found, include all tests
          if [ "$TEST_FILES" = "[]" ]; then
            TEST_FILES=$(find . -name "*.test.*" -o -name "*.spec.*" | jq -R -s -c 'split("\n")[:-1]')
          fi
          
          echo "test-files=$TEST_FILES" >> $GITHUB_OUTPUT
          echo "test-suites=$TEST_SUITES" >> $GITHUB_OUTPUT
          
          echo "ðŸŽ¯ Test Files to Run:"
          echo "$TEST_FILES" | jq .

  # =========================================
  # JOB 5: FILE/FOLDER PUSH TEST TRIGGER
  # =========================================
  test-trigger:
    name: ðŸš¦ Test Trigger Detection
    runs-on: ubuntu-latest
    needs: [change-detection, selective-testing]
    outputs:
      should-run-tests: ${{ steps.trigger.outputs.should-run-tests }}
      test-types: ${{ steps.trigger.outputs.test-types }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš¦ Determine test trigger
        id: trigger
        run: |
          CHANGED_FILES='${{ needs.change-detection.outputs.changed-files }}'
          SHOULD_RUN_TESTS=false
          TEST_TYPES=[]
          
          # Check if test-related files changed
          if echo "$CHANGED_FILES" | jq -r '.[]' | grep -E "\.(js|ts|jsx|tsx|py|go|rs)$" > /dev/null; then
            SHOULD_RUN_TESTS=true
            TEST_TYPES='["unit", "integration"]'
          fi
          
          # Check if test files themselves changed
          if echo "$CHANGED_FILES" | jq -r '.[]' | grep -E "\.(test|spec)\." > /dev/null; then
            SHOULD_RUN_TESTS=true
          fi
          
          # Check if configuration files changed
          if echo "$CHANGED_FILES" | jq -r '.[]' | grep -E "(jest|vitest|cypress|playwright)\.config" > /dev/null; then
            SHOULD_RUN_TESTS=true
          fi
          
          # Override if forced skip
          if [[ "${{ env.FORCE_SKIP_TESTS }}" == "true" ]]; then
            SHOULD_RUN_TESTS=false
            TEST_TYPES="[]"
          fi
          
          echo "should-run-tests=$SHOULD_RUN_TESTS" >> $GITHUB_OUTPUT
          echo "test-types=$TEST_TYPES" >> $GITHUB_OUTPUT
          
          echo "ðŸš¦ Should Run Tests: $SHOULD_RUN_TESTS"
          echo "ðŸ“‹ Test Types: $TEST_TYPES"

  # =========================================
  # JOB 6: BRANCH BASED TRIGGERING
  # =========================================
  branch-strategy:
    name: ðŸŒ¿ Branch-based Strategy
    runs-on: ubuntu-latest
    outputs:
      deploy-environment: ${{ steps.strategy.outputs.deploy-environment }}
      run-security: ${{ steps.strategy.outputs.run-security }}
      run-performance: ${{ steps.strategy.outputs.run-performance }}
      notification-level: ${{ steps.strategy.outputs.notification-level }}
    steps:
      - name: ðŸŒ¿ Determine branch strategy
        id: strategy
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          DEPLOY_ENV="none"
          RUN_SECURITY=false
          RUN_PERFORMANCE=false
          NOTIFICATION_LEVEL="minimal"
          
          case "$BRANCH_NAME" in
            "main")
              DEPLOY_ENV="production"
              RUN_SECURITY=true
              RUN_PERFORMANCE=true
              NOTIFICATION_LEVEL="full"
              ;;
            "develop")
              DEPLOY_ENV="staging"
              RUN_SECURITY=true
              RUN_PERFORMANCE=false
              NOTIFICATION_LEVEL="standard"
              ;;
            #   ;;
            # feature/*)
            #   DEPLOY_ENV="none"
            #   RUN_SECURITY=false
            #   RUN_PERFORMANCE=false
            #   NOTIFICATION_LEVEL="minimal"
            #   ;;
            *)
              DEPLOY_ENV="none"
              RUN_SECURITY=false
              RUN_PERFORMANCE=false
              NOTIFICATION_LEVEL="minimal"
              ;;
          esac
          
          # Override with manual input
          if [[ "${{ github.event.inputs.deploy_environment }}" != "" && "${{ github.event.inputs.deploy_environment }}" != "none" ]]; then
            DEPLOY_ENV="${{ github.event.inputs.deploy_environment }}"
          fi
          
          echo "deploy-environment=$DEPLOY_ENV" >> $GITHUB_OUTPUT
          echo "run-security=$RUN_SECURITY" >> $GITHUB_OUTPUT
          echo "run-performance=$RUN_PERFORMANCE" >> $GITHUB_OUTPUT
          echo "notification-level=$NOTIFICATION_LEVEL" >> $GITHUB_OUTPUT
          
          echo "ðŸŒ¿ Branch: $BRANCH_NAME"
          echo "ðŸš€ Deploy Environment: $DEPLOY_ENV"
          echo "ðŸ”’ Run Security: $RUN_SECURITY"
          echo "âš¡ Run Performance: $RUN_PERFORMANCE"

  # =========================================
  # JOB 7: TEST CODE DETECTION & EXECUTION (Yarn Optimized)
  # =========================================
  test-execution:
    name: ðŸ§ª Test Execution
    runs-on: ubuntu-latest
    needs: [test-trigger, selective-testing, branch-strategy]
    if: needs.test-trigger.outputs.should-run-tests == 'true'
    strategy:
      matrix:
        test-type: ${{ fromJSON(needs.test-trigger.outputs.test-types) }}
        node-version: [20]
      fail-fast: false
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js with Yarn
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org'

      - name: ðŸ”§ Enable Yarn Corepack
        run: |
          echo "ðŸ”§ Enabling Yarn via Corepack..."
          corepack enable
          corepack prepare yarn@stable --activate

      - name: ðŸ”§ Configure Yarn Settings
        run: |
          echo "ðŸ”§ Configuring Yarn settings..."
          yarn config set npmRegistryServer "https://registry.npmjs.org"
          yarn config set enableHardenedMode false
          yarn config set enableInlineBuilds false
          yarn config set enableProgressBars false
          yarn config set logFilters --json '[{"code": "YN0013", "level": "discard"}]'
          
          # Show yarn version
          echo "Yarn version: $(yarn --version)"
          
          # Clear any problematic cache
          yarn cache clean --all 2>/dev/null || true

      - name: ðŸ”§ Install Root Dependencies
        run: |
          echo "ðŸ“¦ Installing root dependencies with Yarn..."
          
          # Remove any existing lockfile and node_modules to avoid conflicts
          rm -f yarn.lock package-lock.json
          rm -rf node_modules .yarn/cache .yarn/install-state.gz 2>/dev/null || true
          
          # Fresh install without lockfile
          yarn install
        env:
          YARN_ENABLE_HARDENED_MODE: false
          YARN_ENABLE_INLINE_BUILDS: false
          CI: true

      - name: ðŸ”§ Install Frontend Dependencies
        if: hashFiles('frontend/package.json') != ''
        run: |
          echo "ðŸŽ¨ Installing frontend dependencies..."
          cd frontend
          
          # Configure yarn for frontend workspace
          yarn config set npmRegistryServer "https://registry.npmjs.org"
          yarn config set enableHardenedMode false
          
          # Remove problematic files
          rm -f yarn.lock package-lock.json
          rm -rf node_modules .yarn/cache .yarn/install-state.gz 2>/dev/null || true
          
          # Install dependencies without lockfile
          yarn install
          
          # Verify installation
          echo "âœ… Frontend dependencies installed successfully"
          ls -la node_modules/.bin/ | head -5 2>/dev/null || echo "No .bin directory found"
          cd ..
        env:
          YARN_ENABLE_HARDENED_MODE: false
          CI: true

      - name: ðŸ”§ Install Backend Dependencies
        if: hashFiles('backend/package.json') != ''
        run: |
          echo "âš™ï¸ Installing backend dependencies..."
          cd backend
          
          # Configure yarn for backend workspace
          yarn config set npmRegistryServer "https://registry.npmjs.org"
          yarn config set enableHardenedMode false
          
          # Remove problematic files
          rm -f yarn.lock package-lock.json
          rm -rf node_modules .yarn/cache .yarn/install-state.gz 2>/dev/null || true
          
          # Install dependencies without lockfile
          yarn install
          
          # Verify installation
          echo "âœ… Backend dependencies installed successfully"
          ls -la node_modules/.bin/ | head -5 2>/dev/null || echo "No .bin directory found"
          cd ..
        env:
          YARN_ENABLE_HARDENED_MODE: false
          CI: true

      - name: ðŸ” Verify Yarn Workspaces
        run: |
          echo "ðŸ” Verifying Yarn workspace setup..."
          
          # Show yarn workspaces if configured
          if yarn workspaces list 2>/dev/null; then
            echo "âœ… Yarn workspaces detected"
          else
            echo "â„¹ï¸ No yarn workspaces configured"
          fi
          
          # Verify frontend setup
          if [ -d "frontend" ]; then
            echo "Frontend status:"
            cd frontend
            yarn --version
            [ -d "node_modules" ] && echo "âœ… node_modules exists" || echo "âŒ node_modules missing"
            cd ..
          fi
          
          # Verify backend setup
          if [ -d "backend" ]; then
            echo "Backend status:"
            cd backend
            yarn --version
            [ -d "node_modules" ] && echo "âœ… node_modules exists" || echo "âŒ node_modules missing"
            cd ..
          fi

      - name: ðŸ§ª Run Frontend Tests
        if: always() && hashFiles('frontend/package.json') != ''
        run: |
          echo "ðŸŽ¨ Running frontend ${{ matrix.test-type }} tests..."
          cd frontend
          
          # Double-check dependencies are installed
          if [ ! -d "node_modules" ]; then
            echo "ðŸ”„ Dependencies missing, reinstalling..."
            rm -f yarn.lock package-lock.json
            yarn install
          fi
          
          # Check for test script in package.json using node
          HAS_TEST_SCRIPT=$(node -p "
            try {
              const pkg = JSON.parse(require('fs').readFileSync('package.json', 'utf8'));
              pkg.scripts && pkg.scripts.test ? pkg.scripts.test : '';
            } catch(e) { 
              ''; 
            }
          ")
          
          if [ -z "$HAS_TEST_SCRIPT" ]; then
            echo "âš ï¸ No test script found in frontend package.json"
            echo "Available scripts:"
            yarn run --json 2>/dev/null | jq -r '.data.items[].name' 2>/dev/null || echo "Could not list scripts"
            exit 0
          fi
          
          echo "âœ… Found test script: $HAS_TEST_SCRIPT"
          
          # Run tests based on type (JavaScript patterns only)
          case "${{ matrix.test-type }}" in
            "unit")
              echo "ðŸ”¬ Running unit tests..."
              yarn test --watchAll=false --coverage --passWithNoTests \
                --testPathPattern="\.test\.(js|jsx)$" \
                --testPathIgnorePatterns="integration" \
                --maxWorkers=2 \
                --forceExit \
                --detectOpenHandles || echo "Unit tests completed with issues"
              ;;
            "integration")
              echo "ðŸ”— Running integration tests..."
              yarn test --watchAll=false --passWithNoTests \
                --testPathPattern="integration|\.integration\.(js|jsx)$" \
                --runInBand \
                --forceExit \
                --detectOpenHandles || echo "Integration tests completed with issues"
              ;;
            *)
              echo "ðŸ§ª Running all tests..."
              yarn test --watchAll=false --coverage --passWithNoTests \
                --maxWorkers=2 \
                --forceExit \
                --detectOpenHandles || echo "All tests completed with issues"
              ;;
          esac
          cd ..
        env:
          CI: true
          NODE_ENV: test
          FORCE_COLOR: true
          NODE_OPTIONS: "--max_old_space_size=4096"

      - name: ðŸ§ª Run Backend Tests
        if: always() && hashFiles('backend/package.json') != ''
        run: |
          echo "âš™ï¸ Running backend ${{ matrix.test-type }} tests..."
          cd backend
          
          # Double-check dependencies are installed
          if [ ! -d "node_modules" ]; then
            echo "ðŸ”„ Dependencies missing, reinstalling..."
            rm -f yarn.lock package-lock.json
            yarn install
          fi
          
          # Check for test script in package.json using node
          HAS_TEST_SCRIPT=$(node -p "
            try {
              const pkg = JSON.parse(require('fs').readFileSync('package.json', 'utf8'));
              pkg.scripts && pkg.scripts.test ? pkg.scripts.test : '';
            } catch(e) { 
              ''; 
            }
          ")
          
          if [ -z "$HAS_TEST_SCRIPT" ]; then
            echo "âš ï¸ No test script found in backend package.json"
            echo "Available scripts:"
            yarn run --json 2>/dev/null | jq -r '.data.items[].name' 2>/dev/null || echo "Could not list scripts"
            exit 0
          fi
          
          echo "âœ… Found test script: $HAS_TEST_SCRIPT"
          
          # Run tests based on type (JavaScript patterns only)
          case "${{ matrix.test-type }}" in
            "unit")
              echo "ðŸ”¬ Running unit tests..."
              yarn test --coverage --passWithNoTests \
                --testPathPattern="\.test\.(js|jsx)$" \
                --testPathIgnorePatterns="integration" \
                --maxWorkers=2 \
                --forceExit \
                --detectOpenHandles || echo "Unit tests completed with issues"
              ;;
            "integration")
              echo "ðŸ”— Running integration tests..."
              yarn test --passWithNoTests \
                --testPathPattern="integration|\.integration\.(js|jsx)$" \
                --runInBand \
                --forceExit \
                --detectOpenHandles || echo "Integration tests completed with issues"
              ;;
            *)
              echo "ðŸ§ª Running all tests..."
              yarn test --coverage --passWithNoTests \
                --maxWorkers=2 \
                --forceExit \
                --detectOpenHandles || echo "All tests completed with issues"
              ;;
          esac
          cd ..
        env:
          CI: true
          NODE_ENV: test
          FORCE_COLOR: true
          NODE_OPTIONS: "--max_old_space_size=4096"

      - name: ðŸŽ¯ Run Specific Test Files
        if: needs.selective-testing.outputs.test-files != '[]' && needs.selective-testing.outputs.test-files != ''
        run: |
          TEST_FILES='${{ needs.selective-testing.outputs.test-files }}'
          echo "ðŸŽ¯ Running specific test files: $TEST_FILES"
          
          # Validate JSON
          if ! echo "$TEST_FILES" | jq . >/dev/null 2>&1; then
            echo "âŒ Invalid JSON format in test files"
            exit 1
          fi
          
          # Run specific tests
          echo "$TEST_FILES" | jq -r '.[]' | while read -r test_file; do
            echo "ðŸ“ Processing test file: $test_file"
            
            if [[ "$test_file" == *"frontend"* ]] && [ -d "frontend" ]; then
              echo "ðŸŽ¨ Running frontend test: $test_file"
              cd frontend
              
              # Ensure dependencies
              if [ ! -d "node_modules" ]; then
                rm -f yarn.lock package-lock.json
                yarn install
              fi
              
              # Run specific test
              relative_path=${test_file#"./frontend/"}
              yarn test --watchAll=false --passWithNoTests "$relative_path" \
                --forceExit --detectOpenHandles || echo "Frontend test completed with issues"
              cd ..
              
            elif [[ "$test_file" == *"backend"* ]] && [ -d "backend" ]; then
              echo "âš™ï¸ Running backend test: $test_file"
              cd backend
              
              # Ensure dependencies
              if [ ! -d "node_modules" ]; then
                rm -f yarn.lock package-lock.json
                yarn install
              fi
              
              # Run specific test
              relative_path=${test_file#"./backend/"}
              yarn test --watchAll=false --passWithNoTests "$relative_path" \
                --forceExit --detectOpenHandles || echo "Backend test completed with issues"
              cd ..
            fi
          done
        env:
          CI: true
          NODE_ENV: test

      - name: ðŸ“Š Upload Frontend Coverage
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('frontend/coverage/**/*') != ''
        with:
          name: frontend-coverage-${{ matrix.test-type }}-node-${{ matrix.node-version }}
          path: frontend/coverage/
          retention-days: 7

      - name: ðŸ“Š Upload Backend Coverage
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('backend/coverage/**/*') != ''
        with:
          name: backend-coverage-${{ matrix.test-type }}-node-${{ matrix.node-version }}
          path: backend/coverage/
          retention-days: 7
          if-no-files-found: ignore

      - name: ðŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.test-type }}-node-${{ matrix.node-version }}
          path: |
            frontend/test-results.xml
            backend/test-results.xml
            frontend/junit.xml
            backend/junit.xml
            frontend/coverage/
            backend/coverage/
          retention-days: 7

      - name: ðŸ“‹ Generate Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Yarn Test Execution Summary (JavaScript Only)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | ${{ matrix.test-type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node Version | ${{ matrix.node-version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Package Manager | Yarn $(yarn --version 2>/dev/null || echo 'N/A') |" >> $GITHUB_STEP_SUMMARY
          echo "| Language | JavaScript (No TypeScript) |" >> $GITHUB_STEP_SUMMARY
          echo "| Lockfile | Disabled (Fresh Install) |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | $([ -d "frontend" ] && echo "âœ… Enabled" || echo "âŒ Not Found") |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Tests | $([ -d "backend" ] && cd backend && node -p "Object.keys(JSON.parse(require('fs').readFileSync('package.json', 'utf8')).scripts || {}).filter(s => s.includes('test')).length > 0 ? 'âœ… Available' : 'â³ Future Ready'" 2>/dev/null || echo "âŒ Not Found") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add coverage info if available
          if [ -f "frontend/coverage/coverage-summary.json" ]; then
            echo "### ðŸŽ¨ Frontend Coverage" >> $GITHUB_STEP_SUMMARY
            node -p "
              try {
                const coverage = JSON.parse(require('fs').readFileSync('frontend/coverage/coverage-summary.json', 'utf8'));
                const total = coverage.total;
                '- Lines: ' + total.lines.pct + '%\\n' +
                '- Statements: ' + total.statements.pct + '%\\n' +
                '- Functions: ' + total.functions.pct + '%\\n' +
                '- Branches: ' + total.branches.pct + '%';
              } catch(e) { 
                'Coverage data not available'; 
              }
            " >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "backend/coverage/coverage-summary.json" ]; then
            echo "### âš™ï¸ Backend Coverage" >> $GITHUB_STEP_SUMMARY
            node -p "
              try {
                const coverage = JSON.parse(require('fs').readFileSync('backend/coverage/coverage-summary.json', 'utf8'));
                const total = coverage.total;
                '- Lines: ' + total.lines.pct + '%\\n' +
                '- Statements: ' + total.statements.pct + '%\\n' +
                '- Functions: ' + total.functions.pct + '%\\n' +
                '- Branches: ' + total.branches.pct + '%';
              } catch(e) { 
                'Coverage data not available'; 
              }
            " >> $GITHUB_STEP_SUMMARY
          fi
  # =========================================
  # JOB 8: UNTESTED CODE HANDLING
  # =========================================
  untested-code-analysis:
    name: ðŸ“Š Untested Code Analysis
    runs-on: ubuntu-latest
    needs: [test-execution]
    if: always()
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ðŸ”§ Install dependencies
        run: yarn install

      - name: ðŸ“Š Analyze untested code
        run: |
          echo "ðŸ“Š Analyzing untested code coverage..."
          
          # Generate coverage report if not exists
          if [ ! -d "coverage" ]; then
            yarn jest --coverage --passWithNoTests || echo "No tests found"
          fi
          
          # Find files without tests
          echo "ðŸ” Files without corresponding test files:"
          find src -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | while read file; do
            base_name=$(echo "$file" | sed 's/\.[^.]*$//')
            if [ ! -f "${base_name}.test.js" ] && [ ! -f "${base_name}.test.ts" ] && [ ! -f "${base_name}.spec.js" ]; then
              echo "âŒ $file (no test file found)"
            fi
          done
          
          # Create untested files report
          echo "ðŸ“‹ Generating untested files report..."
          mkdir -p reports
          find src -name "*.js" -o -name "*.ts" | while read file; do
            base_name=$(echo "$file" | sed 's/\.[^.]*$//')
            if [ ! -f "${base_name}.test.js" ] && [ ! -f "${base_name}.test.ts" ]; then
              echo "$file" >> reports/untested-files.txt
            fi
          done

      - name: ðŸ“„ Upload untested code report
        uses: actions/upload-artifact@v4
        with:
          name: untested-code-report
          path: reports/untested-files.txt
          retention-days: 30

  # =========================================
  # JOB 9: LINTING (ESLint/Prettier)
  # =========================================
  linting:
    name: ðŸ’… Code Quality & Linting
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ðŸ”§ Install dependencies
        run: yarn install

      - name: ESLint Check
        run: |
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ]; then
            echo " Running ESLint..."
            yarn lint || npx eslint . --ext .js,.jsx,.ts,.tsx --format=json --output-file=eslint-results.json
          else
            echo " No ESLint config found"
          fi
        continue-on-error: true

      - name: Prettier Check
        run: |
          if [ -f ".prettierrc" ] || [ -f ".prettierrc.json" ]; then
            echo " Running Prettier..."
            yarn format:check || npm run format:check
          else
            echo " No Prettier config found"
          fi
        continue-on-error: true

      - name: ðŸ“„ Upload lint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-results
          path: |
            eslint-results.json
            prettier-results.txt
          retention-days: 7

  # =========================================
  # JOB 10: SECURITY SCAN
  # =========================================
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [branch-strategy]
    if: needs.branch-strategy.outputs.run-security == 'true'
    permissions:
      security-events: write
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ”’ NPM Security Audit
        run: |
          echo "ðŸ”’ Running npm audit..."
          npm audit --audit-level=moderate --json > npm-audit.json || echo "Vulnerabilities found"
          npm audit --audit-level=moderate || echo "Continuing despite vulnerabilities..."

      - name: ðŸ” Snyk Security Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json > snyk-results.json
        continue-on-error: true

      - name: ðŸ›¡ï¸ CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript,typescript

      - name: ðŸ›¡ï¸ CodeQL Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ðŸ›¡ï¸ CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: ðŸ“„ Upload security results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            npm-audit.json
            snyk-results.json
          retention-days: 30

  # =========================================
  # JOB 11: CACHE & DEPENDENCIES
  # =========================================
  cache-dependencies:
    name: ðŸ—„ï¸ Cache & Dependencies Management
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
      cache-key: ${{ steps.cache.outputs.cache-primary-key }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ðŸ—„ï¸ Cache node_modules
        id: cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache/yarn
            ~/.npm
            .next/cache
            .nuxt
          key: ${{ runner.os }}-deps-${{ hashFiles('**/yarn.lock', '**/package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-deps-${{ hashFiles('**/yarn.lock', '**/package-lock.json') }}-
            ${{ runner.os }}-deps-

      - name: ðŸ”§ Install dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          echo "ðŸ’¾ Cache miss - Installing fresh dependencies..."
          if [ -f "yarn.lock" ]; then
            yarn install --prefer-offline
          elif [ -f "package-lock.json" ]; then
            npm ci --prefer-offline
          else
            npm install --prefer-offline
          fi

      - name: ðŸ’¾ Warm up additional caches
        run: |
          # Warm up TypeScript cache
          if [ -f "tsconfig.json" ]; then
            npx tsc --noEmit --incremental
          fi
          
          # Warm up Next.js cache
          if [ -f "next.config.js" ]; then
            npx next build --no-lint || echo "Next.js build warmup completed"
          fi

      - name: ðŸ“Š Cache statistics
        run: |
          echo "ðŸ“Š Cache Statistics:"
          echo "Cache Hit: ${{ steps.cache.outputs.cache-hit }}"
          echo "Cache Key: ${{ steps.cache.outputs.cache-primary-key }}"
          echo "Node Modules Size: $(du -sh node_modules 2>/dev/null || echo 'Not found')"

  # =========================================
  # JOB 12: BUILD APPLICATION
  # =========================================
  # build:
  #   name: ðŸ—ï¸ Build Application
  #   runs-on: ubuntu-latest
  #   needs: [cache-dependencies, detect-services, linting]
  #   strategy:
  #     matrix:
  #       environment: [development, staging, production]
  #       include:
  #         - environment: development
  #           build_mode: development
  #           optimize: false
  #         - environment: staging
  #           build_mode: staging
  #           optimize: true
  #         - environment: production
  #           build_mode: production
  #           optimize: true
  #   steps:
  #     - name: ðŸ“¥ Checkout code
  #       uses: actions/checkout@v4

  #     - name: ðŸ“¦ Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         cache: 'yarn'

  #     - name: ðŸ—„ï¸ Restore dependencies cache
  #       uses: actions/cache@v3
  #       with:
  #         path: |
  #           node_modules
  #           ~/.cache/yarn
  #         key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}-${{ github.sha }}
  #         restore-keys: |
  #           ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
  #           ${{ runner.os }}-yarn-

  #     - name: ðŸ”§ Install dependencies (if cache miss)
  #       if: needs.cache-dependencies.outputs.cache-hit != 'true'
  #       run: yarn install --frozen-lockfile

  #     - name: ðŸ—ï¸ Build Frontend
  #       if: needs.detect-services.outputs.has-frontend == 'true'
  #       run: |
  #         echo "ðŸŽ¨ Building Frontend (${{ needs.detect-services.outputs.frontend-framework }})..."
          
  #         case "${{ needs.detect-services.outputs.frontend-framework }}" in
  #           "react")
  #             yarn build || npm run build
  #             ;;
  #           "nextjs")
  #             yarn build || npx next build
  #             ;;
  #           "vue")
  #             yarn build || npm run build
  #             ;;
  #           "angular")
  #             yarn build --prod || ng build --prod
  #             ;;
  #           "svelte")
  #             yarn build || npm run build
  #             ;;
  #           *)
  #             yarn build || npm run build
  #             ;;
  #         esac
  #       env:
  #         NODE_ENV: ${{ matrix.build_mode }}
  #         OPTIMIZE: ${{ matrix.optimize }}

  #     - name: ðŸ—ï¸ Build Backend
  #       if: needs.detect-services.outputs.has-backend == 'true'
  #       run: |
  #         echo "âš™ï¸ Building Backend (${{ needs.detect-services.outputs.backend-framework }})..."
          
  #         case "${{ needs.detect-services.outputs.backend-framework }}" in
  #           "nodejs")
  #             if [ -f "tsconfig.json" ]; then
  #               yarn build || npx tsc
  #             else
  #               echo "âœ… Node.js project - no build step required"
  #             fi
  #             ;;
  #           "python")
  #             echo "ðŸ Python project - installing dependencies..."
  #             pip install -r requirements.txt
  #             ;;
  #           "golang")
  #             echo "ðŸ¹ Building Go application..."
  #             go build -o app ./...
  #             ;;
  #           "rust")
  #             echo "ðŸ¦€ Building Rust application..."
  #             cargo build --release
  #             ;;
  #         esac
  #       env:
  #         NODE_ENV: ${{ matrix.build_mode }}

  #     - name: ðŸ“¦ Archive build artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: build-${{ matrix.environment }}-${{ github.sha }}
  #         path: |
  #           dist/
  #           build/
  #           out/
  #           .next/
  #           target/release/
  #           app
  #         retention-days: 7

  #     - name: ðŸ“Š Build size analysis
  #       run: |
  #         echo "ðŸ“Š Build Size Analysis for ${{ matrix.environment }}:"
  #         if [ -d "dist" ]; then
  #           echo "Dist folder size: $(du -sh dist)"
  #           find dist -name "*.js" -exec ls -lh {} \; | head -10
  #         fi
  #         if [ -d "build" ]; then
  #           echo "Build folder size: $(du -sh build)"
  #         fi

  # =========================================
  # JOB 13: BUNDLE SIZE CHECK (IMPROVED)
  # =========================================
  # bundle-size-check:
  #   name: ðŸ“¦ Bundle Size Analysis
  #   runs-on: ubuntu-latest
  #   needs: [build, detect-services]
  #   # Force run for debugging - remove conditions temporarily
  #   if: always()
  #   steps:
  #     - name: ðŸ” Debug Job Conditions
  #       run: |
  #         echo "=== JOB CONDITION DEBUG ==="
  #         echo "detect-services.result: '${{ needs.detect-services.result }}'"
  #         echo "detect-services.conclusion: '${{ needs.detect-services.conclusion }}'"
  #         echo "build.result: '${{ needs.build.result }}'"
  #         echo "build.conclusion: '${{ needs.build.conclusion }}'"
  #         echo "has-frontend output: '${{ needs.detect-services.outputs.has-frontend }}'"
  #         echo "has-frontend raw value: ${{ needs.detect-services.outputs.has-frontend }}"
  #         echo ""
  #         echo "=== All detect-services outputs ==="
  #         echo '${{ toJSON(needs.detect-services.outputs) }}'

  #     - name: ðŸ“¥ Checkout code
  #       uses: actions/checkout@v4

  #     - name: ðŸ“¦ Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'

  #     - name: ðŸ“¦ Download build artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: build-production-${{ github.sha }}
  #         path: ./build
  #       continue-on-error: true

  #     - name: ðŸ” Verify build artifacts
  #       run: |
  #         echo "Checking build artifacts..."
  #         if [ -d "./build" ]; then
  #           echo "âœ… Build directory found"
  #           ls -la ./build
  #         else
  #           echo "âŒ No build directory found - checking for other build outputs"
  #           find . -name "dist" -o -name ".next" -o -name "out" -type d | head -5
  #         fi

  #     - name: ðŸ“Š Analyze bundle size
  #       run: |
  #         echo "ðŸ” Analyzing bundle sizes..."
          
  #         # Install bundle analyzer tools globally
  #         npm install -g bundlesize webpack-bundle-analyzer || true

  #         # Initialize report
  #         mkdir -p reports
  #         echo "# ðŸ“¦ Bundle Size Report" > reports/bundle-size.md
  #         echo "Generated on: $(date)" >> reports/bundle-size.md
  #         echo "Commit: ${{ github.sha }}" >> reports/bundle-size.md
  #         echo "" >> reports/bundle-size.md

  #         # Function to analyze directory
  #         analyze_directory() {
  #           local dir=$1
  #           local build_type=$2
            
  #           if [ -d "$dir" ]; then
  #             echo "## $build_type Build Analysis" >> reports/bundle-size.md
  #             echo "" >> reports/bundle-size.md
              
  #             # Find JS and CSS files
  #             js_files=$(find "$dir" -name "*.js" -not -path "*/node_modules/*" | wc -l)
  #             css_files=$(find "$dir" -name "*.css" -not -path "*/node_modules/*" | wc -l)
              
  #             echo "ðŸ“Š **Files found:** $js_files JS, $css_files CSS" >> reports/bundle-size.md
  #             echo "" >> reports/bundle-size.md
              
  #             # Calculate total sizes
  #             if [ $js_files -gt 0 ]; then
  #               total_js_size=$(find "$dir" -name "*.js" -not -path "*/node_modules/*" -exec du -b {} \; | awk '{sum+=$1} END {print sum}' || echo "0")
  #               echo "ðŸ“¦ **Total JS Size:** $(echo $total_js_size | numfmt --to=iec-i --suffix=B)" >> reports/bundle-size.md
                
  #               # Size warnings
  #               if [ $total_js_size -gt 1048576 ]; then # 1MB
  #                 echo "âš ï¸ **Warning:** JS bundle size exceeds 1MB" >> reports/bundle-size.md
  #               elif [ $total_js_size -gt 512000 ]; then # 512KB
  #                 echo "ðŸ’¡ **Note:** JS bundle size is above 512KB" >> reports/bundle-size.md
  #               else
  #                 echo "âœ… **Good:** JS bundle size is reasonable" >> reports/bundle-size.md
  #               fi
  #             fi
              
  #             if [ $css_files -gt 0 ]; then
  #               total_css_size=$(find "$dir" -name "*.css" -not -path "*/node_modules/*" -exec du -b {} \; | awk '{sum+=$1} END {print sum}' || echo "0")
  #               echo "ðŸŽ¨ **Total CSS Size:** $(echo $total_css_size | numfmt --to=iec-i --suffix=B)" >> reports/bundle-size.md
  #             fi
              
  #             echo "" >> reports/bundle-size.md
  #             echo "### ðŸ“‹ File Details" >> reports/bundle-size.md
              
  #             # List individual files with sizes
  #             find "$dir" -type f \( -name "*.js" -o -name "*.css" \) -not -path "*/node_modules/*" | sort | while read file; do
  #               if [ -f "$file" ]; then
  #                 size=$(du -h "$file" | cut -f1)
  #                 rel_path=${file#$dir/}
  #                 echo "- \`$rel_path\`: **$size**" >> reports/bundle-size.md
  #               fi
  #             done
              
  #             echo "" >> reports/bundle-size.md
  #             return 0
  #           fi
  #           return 1
  #         }

  #         # Analyze different build patterns
  #         analyzed=false
          
  #         # React/CRA build
  #         if analyze_directory "build/static" "React (Create React App)"; then
  #           echo "âœ… React/CRA build analyzed"
  #           analyzed=true
  #         elif analyze_directory "build" "Generic Build"; then
  #           echo "âœ… Generic build analyzed"
  #           analyzed=true
  #         fi
          
  #         # Next.js build
  #         if analyze_directory ".next/static" "Next.js"; then
  #           echo "âœ… Next.js build analyzed"
  #           analyzed=true
  #         fi
          
  #         # Vite build
  #         if analyze_directory "dist/assets" "Vite"; then
  #           echo "âœ… Vite build analyzed"
  #           analyzed=true
  #         elif analyze_directory "dist" "Distribution"; then
  #           echo "âœ… Distribution build analyzed"
  #           analyzed=true
  #         fi
          
  #         # Webpack build
  #         if analyze_directory "public/build" "Webpack"; then
  #           echo "âœ… Webpack build analyzed"
  #           analyzed=true
  #         fi
          
  #         if [ "$analyzed" = false ]; then
  #           echo "## âš ï¸ No Build Output Found" >> reports/bundle-size.md
  #           echo "" >> reports/bundle-size.md
  #           echo "No recognizable build output was detected. Checked locations:" >> reports/bundle-size.md
  #           echo "- \`build/\`, \`build/static/\`" >> reports/bundle-size.md
  #           echo "- \`dist/\`, \`dist/assets/\`" >> reports/bundle-size.md
  #           echo "- \`.next/static/\`" >> reports/bundle-size.md
  #           echo "- \`public/build/\`" >> reports/bundle-size.md
  #           echo "" >> reports/bundle-size.md
            
  #           # Show what we found instead
  #           echo "### ðŸ” Available Directories" >> reports/bundle-size.md
  #           find . -maxdepth 2 -type d -name "*build*" -o -name "*dist*" -o -name ".next" | head -10 | while read dir; do
  #             echo "- \`$dir\`" >> reports/bundle-size.md
  #           done
  #         fi

  #     - name: ðŸ” Run bundlesize checks
  #       run: |
  #         if [ -f "package.json" ] && grep -q "bundlesize" package.json; then
  #           echo "ðŸ” Running bundlesize checks..."
  #           npx bundlesize || echo "âš ï¸ Bundlesize check completed with warnings"
  #         else
  #           echo "ðŸ’¡ No bundlesize configuration found in package.json"
  #           echo "" >> reports/bundle-size.md
  #           echo "## ðŸ’¡ Bundlesize Setup" >> reports/bundle-size.md
  #           echo "" >> reports/bundle-size.md
  #           echo "Consider adding bundlesize configuration to your \`package.json\`:" >> reports/bundle-size.md
  #           echo '```json' >> reports/bundle-size.md
  #           echo '"bundlesize": [' >> reports/bundle-size.md
  #           echo '  {' >> reports/bundle-size.md
  #           echo '    "path": "./build/static/js/*.js",' >> reports/bundle-size.md
  #           echo '    "maxSize": "1mb"' >> reports/bundle-size.md
  #           echo '  }' >> reports/bundle-size.md
  #           echo ']' >> reports/bundle-size.md
  #           echo '```' >> reports/bundle-size.md
  #         fi

  #     - name: ðŸ“„ Upload bundle analysis
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: bundle-size-analysis-${{ github.sha }}
  #         path: |
  #           reports/
  #           build/static/**/*.map
  #           .next/static/**/*.map
  #           dist/**/*.map
  #         retention-days: 14

  #     - name: ðŸ’¬ Comment bundle size on PR
  #       if: github.event_name == 'pull_request'
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           const fs = require('fs');
  #           const path = require('path');
            
  #           const reportPath = 'reports/bundle-size.md';
            
  #           if (fs.existsSync(reportPath)) {
  #             const bundleReport = fs.readFileSync(reportPath, 'utf8');
              
  #             // Truncate if too long (GitHub comment limit)
  #             const maxLength = 60000;
  #             const report = bundleReport.length > maxLength 
  #               ? bundleReport.substring(0, maxLength) + '\n\n*... (report truncated due to length)*'
  #               : bundleReport;
              
  #             try {
  #               // Check if comment already exists
  #               const { data: comments } = await github.rest.issues.listComments({
  #                 issue_number: context.issue.number,
  #                 owner: context.repo.owner,
  #                 repo: context.repo.repo
  #               });
                
  #               const existingComment = comments.find(comment => 
  #                 comment.body.includes('Bundle Size Analysis') && 
  #                 comment.user.type === 'Bot'
  #               );
                
  #               if (existingComment) {
  #                 // Update existing comment
  #                 await github.rest.issues.updateComment({
  #                   comment_id: existingComment.id,
  #                   owner: context.repo.owner,
  #                   repo: context.repo.repo,
  #                   body: report
  #                 });
  #                 console.log('Updated existing bundle size comment');
  #               } else {
  #                 // Create new comment
  #                 await github.rest.issues.createComment({
  #                   issue_number: context.issue.number,
  #                   owner: context.repo.owner,
  #                   repo: context.repo.repo,
  #                   body: report
  #                 });
  #                 console.log('Created new bundle size comment');
  #               }
  #             } catch (error) {
  #               console.error('Failed to post/update comment:', error);
  #               // Don't fail the job if commenting fails
  #             }
  #           } else {
  #             console.log('No bundle size report found to comment');
  #           }
  
  # JOB 20: NOTIFICATIONS
  # =========================================
  # notifications:
  #   name: ðŸ”” Notifications & Reporting
  #   runs-on: ubuntu-latest
  #   needs: [
  #     monorepo-versioning, 
  #     test-execution, 
  #     build, 
  #     # deploy, 
  #     # performance-test, 
  #     security-scan,
  #     branch-strategy
  #   ]
  #   if: always()
  #   steps:
  #     - name: ðŸ“¥ Checkout code
  #       uses: actions/checkout@v4

  #     - name: ðŸ“Š Generate comprehensive report
  #       run: |
  #         echo "ðŸ“Š Generating comprehensive CI/CD report..."
          
  #         mkdir -p reports
  #         REPORT_FILE="reports/cicd-report.md"
          
  #         # Generate markdown report
  #         cat > $REPORT_FILE << EOF
  #         # ðŸš€ CI/CD Pipeline Report
          
  #         **Date**: $(date)
  #         **Branch**: ${{ github.ref_name }}
  #         **Commit**: ${{ github.sha }}
  #         **Triggered by**: ${{ github.event_name }}
          
  #         ## ðŸ“‹ Pipeline Summary
          
  #         | Stage | Status | Duration | Notes |
  #         |-------|--------|----------|--------|
  #         | Versioning | ${{ needs.monorepo-versioning.result }} | - | Version: ${{ needs.monorepo-versioning.outputs.version }} |
  #         | Testing | ${{ needs.test-execution.result }} | - | ${{ needs.test-execution.result == 'skipped' && 'No tests required' || 'Tests completed' }} |
  #         | Build | ${{ needs.build.result }} | - | Multi-environment build |
  #         | Security | ${{ needs.security-scan.result }} | - | Security scan completed |
  #         | Deploy | ${{ needs.deploy.result }} | - | Target: ${{ needs.branch-strategy.outputs.deploy-environment }} |
  #         | Performance | ${{ needs.performance-test.result }} | - | ${{ needs.performance-test.result == 'skipped' && 'Not required for branch' || 'Performance tests completed' }} |
          
  #         ## ðŸŽ¯ Key Metrics
          
  #         - **New Version**: ${{ needs.monorepo-versioning.outputs.version }}
  #         - **Environment**: ${{ needs.branch-strategy.outputs.deploy-environment }}
  #         - **Notification Level**: ${{ needs.branch-strategy.outputs.notification-level }}
          
  #         EOF
          
  #         # Add deployment URL if available
  #         if [ "${{ needs.deploy.outputs.url }}" != "" ]; then
  #           echo "- **Deployment URL**: ${{ needs.deploy.outputs.url }}" >> $REPORT_FILE
  #         fi
          
  #         echo "" >> $REPORT_FILE
  #         echo "## ðŸ” Detailed Results" >> $REPORT_FILE
          
  #         # Add detailed results based on job outcomes
  #         if [ "${{ needs.test-execution.result }}" = "failure" ]; then
  #           echo "âŒ **Tests Failed**: Some tests did not pass" >> $REPORT_FILE
  #         elif [ "${{ needs.test-execution.result }}" = "success" ]; then
  #           echo "âœ… **Tests Passed**: All tests completed successfully" >> $REPORT_FILE
  #         fi
          
  #         if [ "${{ needs.security-scan.result }}" = "failure" ]; then
  #           echo "ðŸ”’ **Security Issues**: Security vulnerabilities detected" >> $REPORT_FILE
  #         elif [ "${{ needs.security-scan.result }}" = "success" ]; then
  #           echo "âœ… **Security**: No critical vulnerabilities found" >> $REPORT_FILE
  #         fi

  #     # - name: ðŸ”” Discord Notification
  #     #   if: contains(fromJSON('["full", "standard"]'), needs.branch-strategy.outputs.notification-level)
  #     #   uses: sarisia/actions-status-discord@v1
  #     #   with:
  #     #     webhook: ${{ secrets.DISCORD_WEBHOOK }}
  #     #     title: "ðŸš€ CI/CD Pipeline Report"
  #     #     description: |
  #     #       **Branch**: ${{ github.ref_name }}
  #     #       **Version**: ${{ needs.monorepo-versioning.outputs.version }}
  #     #       **Environment**: ${{ needs.branch-strategy.outputs.deploy-environment }}
  #     #       **Status**: ${{ job.status }}
  #     #     color: ${{ job.status == 'success' && '3066993' || job.status == 'failure' && '15158332' || '16776960' }}
  #     #     username: "GitHub Actions"
  #     #     avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

  #     # - name: ðŸ“§ Email Notification
  #     #   if: |
  #     #     needs.branch-strategy.outputs.notification-level == 'full' && 
  #     #     (job.status == 'failure' || needs.branch-strategy.outputs.deploy-environment == 'production')
  #     #   uses: dawidd6/action-send-mail@v3
  #     #   with:
  #     #     server_address: smtp.gmail.com
  #     #     server_port: 587
  #     #     username: ${{ secrets.EMAIL_USERNAME }}
  #     #     password: ${{ secrets.EMAIL_PASSWORD }}
  #     #     subject: "ðŸš€ CI/CD Pipeline Report - ${{ github.repository }}"
  #     #     body: file://reports/cicd-report.md
  #     #     to: ${{ secrets.NOTIFICATION_EMAIL }}
  #     #     from: "GitHub Actions <${{ secrets.EMAIL_USERNAME }}>"
  #     #     content_type: text/markdown

  #     # - name: ðŸ“± Slack Notification
  #     #   if: needs.branch-strategy.outputs.notification-level == 'full'
  #     #   uses: 8398a7/action-slack@v3
  #     #   with:
  #     #     status: ${{ job.status }}
  #     #     channel: '#deployments'
  #     #     username: 'GitHub Actions'
  #     #     icon_emoji: ':rocket:'
  #     #     fields: repo,message,commit,author,action,eventName,ref,workflow
  #     #     custom_payload: |
  #     #       {
  #     #         attachments: [{
  #     #           color: '${{ job.status }}' === 'success' ? 'good' : '${{ job.status }}' === 'failure' ? 'danger' : 'warning',
  #     #           blocks: [
  #     #             {
  #     #               type: 'section',
  #     #               text: {
  #     #                 type: 'mrkdwn',
  #     #                 text: `ðŸš€ *CI/CD Pipeline Report*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Environment:* ${{ needs.branch-strategy.outputs.deploy-environment }}\n*Status:* ${{ job.status }}`
  #     #               }
  #     #             }
  #     #           ]
  #     #         }]
  #     #       }
  #     #   env:
  #     #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  #     - name: ðŸ“„ Upload final report
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: cicd-pipeline-report
  #         path: reports/cicd-report.md
  #         retention-days: 90

  #     - name: ðŸ“Š Update GitHub Status
  #       if: always()
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           const status = '${{ job.status }}' === 'success' ? 'success' : 'failure';
  #           const description = `CI/CD Pipeline ${status} - Version: ${{ needs.monorepo-versioning.outputs.version }}`;
            
  #           github.rest.repos.createCommitStatus({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             sha: context.sha,
  #             state: status,
  #             target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
  #             description: description,
  #             context: 'CI/CD Pipeline'
  #           });

  #     - name: ðŸ Pipeline Summary
  #       run: |
  #         echo "## ðŸš€ CI/CD Pipeline Completed!" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "### ðŸ“Š Summary" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Version**: ${{ needs.monorepo-versioning.outputs.version }}" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Environment**: ${{ needs.branch-strategy.outputs.deploy-environment }}" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Pipeline Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          
  #         if [ "${{ needs.deploy.outputs.url }}" != "" ]; then
  #           echo "- **Deployment URL**: ${{ needs.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
  #         fi
          
  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "### ðŸŽ¯ Key Results" >> $GITHUB_STEP_SUMMARY
  #         echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
  #         echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
  #         echo "| Tests | ${{ needs.test-execution.result }} |" >> $GITHUB_STEP_SUMMARY
  #         echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
  #         echo "| Security | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
  #         echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY

  # =========================================
  # SIMPLE DEBUG - ALWAYS RUNS
  # =========================================
  simple-debug:
    name: ðŸ” Always Run Debug
    runs-on: ubuntu-latest
    steps:
      - name: Basic Info
        run: |
          echo "=== BASIC DEBUG INFO ==="
          echo "GitHub Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"
          echo "SHA: ${{ github.sha }}"
